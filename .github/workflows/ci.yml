name: DevOps CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    workflow_dispatch:

jobs:
    lint-and-test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4
            - name: Basic info
              run: |
                  uname -a
                  pwd
                  ls -la
            - name: Set up python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"
            - name: Install dependencies
              run: |
                  if [ -f requirements.txt ]; then
                    pip install -r requirements.txt
                  else
                    echo "No requirements.txt"
                  fi
            - name: Python check
              run: |
                  python -m compileall app
            - name: Helm install
              run: |
                  curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
            - name: Helm lint
              run: helm lint charts/flask-app

    docker-build:
        runs-on: ubuntu-latest
        needs: lint-and-test
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4
            - name: Docker build test
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: false
                  tags: flask-helm-k8s:test
